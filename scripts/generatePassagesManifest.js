import * as fs from 'fs-extra';
import {
  getAutogeneratedFileWarningText,
} from './functions/getAutogeneratedFileWarningText';
import {
  getAuthoredImportsMetadata,
} from './functions/getAuthoredImportsMetadata';
import {
  getHotReloadAcceptor,
} from './functions/getHotReloadAcceptor';
import {
  getAuthoredAssetObjectDefinitions,
} from './functions/getAuthoredAssetObjectDefinitions';
import * as path from 'path';
import {
  scrapeAssets,
} from './functions/scrapeAssets';
import {
  setUnhandledRejectionEvent,
} from './functions/setUnhandledRejectionEvent';

setUnhandledRejectionEvent();

const authoredPassagesDir = path.join(__dirname, '..', 'passages');

(async () => {
  try {
    /* Do not include the init file as a passage. */
    const files = await scrapeAssets(authoredPassagesDir);

    const {
      importPaths,
      imports,
      registry,
    } = getAuthoredImportsMetadata(files);

    const authoredAssets = getAuthoredAssetObjectDefinitions(files);
    const hotReloadAcceptor = getHotReloadAcceptor(importPaths);

    const manifestStr =
      getAutogeneratedFileWarningText() +
      '\n\nimport {\n  IPassageManifestItem,\n} from \'../src/passages/IPassageManifestItem\';\n' +
      '\n' +
      (imports.length ? `${imports.join('\n')}\n\n` : '') +
      'const manifest: readonly IPassageManifestItem[] = ' +
      (authoredAssets.length ? `[\n${authoredAssets.join('\n\n')}\n];` : '[];') +
      '\n\n' +
      'export default manifest;\n\n' +
      `export const registry = ${JSON.stringify(registry, null, 2)};\n` +
      (hotReloadAcceptor ? `\n${hotReloadAcceptor}` : '');

    const manifestPath = path.join(authoredPassagesDir, 'passages-manifest.ts');
    await fs.writeFile(manifestPath, manifestStr);
  } catch (err) {
    console.error(err);
    process.exit(1);
  }
})();
